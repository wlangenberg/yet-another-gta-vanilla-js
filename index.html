<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="functions.js"></script>
        <title>Document</title>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            canvas {
                width: 100%;
                height: 100%;
                background-color: green;
                display: block;
                position: relative;
            } 
            .platform {
                background-color: blue;
                position: absolute;
            }
            .character {
                background-color: white;
                position: absolute;
            }
        </style>
        <script>
        </script>
    </head>
    <body>
        <canvas></canvas>
    </body>
    <script> 
        const canvas = document.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const gravity = 0.1;
        const keys = [];
        let players = [];

        class Player {
            constructor(x, y, width, height, color) {
                this.id = getRandomUInt();
                this.name = "Player" + this.id;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.dy = 0;
                this.jumpForce = 10;
                this.maxSpeed = 25;
                this.friction = 0.12;
                this.speed = 0;
                this.direction = 0;
                this.maxAcceleration = 4;
                this.acceleration = 0;
                this.originalHeight = height;
                this.grounded = false;
                this.jumpTimer = 0;
            }

            animate(interval) { 
                this.dy += gravity * interval;
                this.y += this.dy;
                if (this.grounded) this.speed *= interval * this.friction;

                this.speed = this.speed < 0.001 ? 0 : this.speed;
                this.x += Math.min(this.maxSpeed * interval, this.speed) * this.direction;
                

                // Check for jump time
                if (this.jumpTimer > 0) {
                    this.jumpTimer--;
                    this.dy = -this.jumpForce;
                }

                // Check for ground
                if (this.y + this.height > canvas.height - 100) {
                    this.y = canvas.height - this.height - 100;
                    this.grounded = true;
                    this.dy = 0;
                }

                this.draw();
                <!-- console.log("SPEED:", this.speed, "ACCELERATION:", this.acceleration, "DIRECTION:", this.direction) -->
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            move(interval) {
                // let acceleration = this.acceleration * interval;
                if (keys['ArrowUp'] && this.grounded) {
                    this.jumpTimer = 12;
                    this.y -= 10;
                    this.grounded = false;
                }
                if (keys['ArrowRight']) {
                    // If the player is going left and the speed is greater than 1
                    if (this.acceleration > 0 && this.direction === -1) {
                        this.speed -= this.acceleration;
                        if (this.speed < 0) {
                            this.speed = 0;
                            this.acceleration = 0;
                        }
                        // this.speed = Math.max(0, this.speed);
                        return;
                    }

                    // GOING FORWARD
                    if (this.grounded) {
                        this.direction = 1;
                        this.acceleration = Math.min(this.maxAcceleration, this.acceleration + 0.01 * interval);
                        this.speed += this.acceleration;
                        return
                    }
                }
                if (keys['ArrowLeft']) {
                    if (this.acceleration > 0 && this.direction === 1) {
                        this.speed -= this.acceleration;
                        if (this.speed < 0) {
                            this.speed = Math.abs(this.speed);
                            this.acceleration = 0;
                        }
                        return;
                    } 

                    // GOING FORWARD
                    if (this.grounded) {
                        this.direction = -1;
                        this.acceleration = Math.min(this.maxAcceleration, this.acceleration + 0.01 * interval);
                        this.speed += this.acceleration;
                        return
                    }

                }
                this.acceleration = 0;
            }
        }

        class Platform {
            constructor(x, y, width, height, color) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        function createPlayerFromJson(json) {
            const player = new Player(json.x, json.y, json.width, json.height, json.color);
            player.id = json.id;
            player.name = json.name;
            player.dy = json.dy;
            player.jumpForce = json.jumpForce;
            player.maxSpeed = json.maxSpeed;
            player.friction = json.friction;
            player.speed = json.speed;
            player.direction = json.direction;
            player.acceleration = json.acceleration;
            player.originalHeight = json.originalHeight;
            player.grounded = json.grounded;
            player.jumpTimer = json.jumpTimer;
            return player;
        }

        const ws = new WebSocket('ws://localhost:8081/ws');

        ws.onopen = () => {
            console.log('Connected to server');
        }

        ws.onmessage = (message) => {
            try {
                const data = JSON.parse(message.data);
                const player = createPlayerFromJson(data);
                let found = false;
                if (player.id === myplayer.id) {
                    return;
                }
                for (let j = 0; j < players.length; j++) {
                    if (players[j].id === player.id) {
                        players[j] = player;
                        return
                    }
                }
                players.push(player);
            } catch (error) {
                console.error(error);
            }
        }

        let updatePlayerState = (playerData) => {
            <!-- console.log("Sending player state to server", playerData); -->
            ws.send(JSON.stringify(playerData));
        }

        const myplayer = new Player(20, 20, 50, 50, 'white');
        const platform = new Platform(0, canvas.height - 100, canvas.width, 100, 'blue');
        myplayer.draw();
        platform.draw();
        const fps = 144;
        const interval = 1000 / fps;
        let lastTime = 0;

        const tick = (timestamp) => {
            if (timestamp - lastTime >= interval) {
                lastTime = timestamp;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                myplayer.animate(interval);
                myplayer.move(interval);
                platform.draw();

                for (let i = 0; i < players.length; i++) {
                    players[i].draw();
                }
                if (myplayer.speed > 0) {
                    updatePlayerState(myplayer);
                }
            }


            requestAnimationFrame(tick);
        };

        tick(0);


        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
    </script>
</html>
