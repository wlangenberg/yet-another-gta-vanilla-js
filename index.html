<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            canvas {
                width: 100%;
                height: 100%;
                background-color: green;
                display: block;
                position: relative;
            } 
            .platform {
                background-color: blue;
                position: absolute;
            }
            .character {
                background-color: white;
                position: absolute;
            }
        </style>
        <script>
            const players = [];
            // Connect to localhost ws server for player movement
            const ws = new WebSocket('ws://localhost:8081/ws');
            ws.onopen = () => {
                console.log('Connected to server');
            }
            ws.onmessage = (message) => {
                console.log(message.data);
            }
            let sendMessages = (msg) => {
                ws.send(JSON.stringify(msg));
            }
        </script>
    </head>
    <body>
        <canvas></canvas>
    </body>
    <script> 
        const canvas = document.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const gravity = 0.1;
        const fps = 144;
        const interval = 1000 / fps;
        const keys = [];
        let lastTime = 0;


        class Player {
            constructor(x, y, width, height, color) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.dy = 0;
                this.jumpForce = 10;
                this.maxSpeed = 25;
                this.friction = 0.12;
                this.speed = 0;
                this.direction = 0;
                this.maxAcceleration = 4;
                this.acceleration = 0;
                this.originalHeight = height;
                this.grounded = false;
                this.jumpTimer = 0;
            }

            animate(interval) { 
                this.dy += gravity * interval;
                this.y += this.dy;
                if (this.grounded) this.speed *= interval * this.friction;

                this.x += Math.min(this.maxSpeed * interval, this.speed) * this.direction;
                

                // Check for jump time
                if (this.jumpTimer > 0) {
                    this.jumpTimer--;
                    this.dy = -this.jumpForce;
                }

                // Check for ground
                if (this.y + this.height > canvas.height - 100) {
                    this.y = canvas.height - this.height - 100;
                    this.grounded = true;
                    this.dy = 0;
                }

                this.draw();
                console.log("SPEED:", this.speed, "ACCELERATION:", this.acceleration, "DIRECTION:", this.direction)
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            move(interval) {
                // let acceleration = this.acceleration * interval;
                if (keys['ArrowUp'] && this.grounded) {
                    this.jumpTimer = 12;
                    this.y -= 10;
                    this.grounded = false;
                }
                if (keys['ArrowRight']) {
                    // If the player is going left and the speed is greater than 1
                    if (this.acceleration > 0 && this.direction === -1) {
                        this.speed -= this.acceleration;
                        if (this.speed < 0) {
                            this.speed = 0;
                            this.acceleration = 0;
                        }
                        // this.speed = Math.max(0, this.speed);
                        return;
                    }

                    // GOING FORWARD
                    if (this.grounded) {
                        this.direction = 1;
                        this.acceleration = Math.min(this.maxAcceleration, this.acceleration + 0.01 * interval);
                        this.speed += this.acceleration;
                        return
                    }
                }
                if (keys['ArrowLeft']) {
                    if (this.acceleration > 0 && this.direction === 1) {
                        this.speed -= this.acceleration;
                        if (this.speed < 0) {
                            this.speed = Math.abs(this.speed);
                            this.acceleration = 0;
                        }
                        return;
                    } 

                    // GOING FORWARD
                    if (this.grounded) {
                        this.direction = -1;
                        this.acceleration = Math.min(this.maxAcceleration, this.acceleration + 0.01 * interval);
                        this.speed += this.acceleration;
                        return
                    }

                }
                this.acceleration = 0;
            }
        }

        class Platform {
            constructor(x, y, width, height, color) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        const player = new Player(20, 20, 50, 50, 'white');
        const platform = new Platform(0, canvas.height - 100, canvas.width, 100, 'blue');
        player.draw();
        platform.draw();

        const tick = (timestamp) => {
            if (timestamp - lastTime >= interval) {
                lastTime = timestamp;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                player.animate(interval);
                player.move(interval);
                platform.draw();
            }

        otherplayers = [];
            requestAnimationFrame(tick);
        };

        tick(0);


        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
    </script>
</html>
